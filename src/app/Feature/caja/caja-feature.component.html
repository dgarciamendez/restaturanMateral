<div class="caja-container">
    <mat-card>
        <mat-card-header>
            <mat-card-title>Control de Caja</mat-card-title>
            <mat-card-subtitle>
                Estado: {{ cajaActual ? 'ABIERTA' : 'CERRADA' }}
            </mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
            <mat-tab-group [(selectedIndex)]="activeTabIndex" animationDuration="0ms">

                <!-- Tab 1: Apertura -->
                <mat-tab label="Apertura de Caja" [disabled]="!!cajaActual">
                    <div class="tab-content">
                        <p>Inicie el turno declarando el fondo inicial.</p>
                        <form [formGroup]="aperturaForm" (ngSubmit)="abrirCaja()">
                            <mat-form-field appearance="outline" class="full-width">
                                <mat-label>Fondo Inicial</mat-label>
                                <input matInput type="number" formControlName="montoInicial" placeholder="0.00">
                                <span matTextPrefix>$&nbsp;</span>
                            </mat-form-field>
                            <button mat-raised-button color="primary" type="submit" [disabled]="aperturaForm.invalid">
                                Abrir Caja
                            </button>
                        </form>
                    </div>
                </mat-tab>

                <!-- Tab 2: Movimientos -->
                <mat-tab label="Movimientos (In-Out)" [disabled]="!cajaActual">
                    <div class="tab-content">
                        <form [formGroup]="movimientoForm" (ngSubmit)="registrarMovimiento()" class="movimiento-form">
                            <div class="form-row">
                                <mat-form-field appearance="outline">
                                    <mat-label>Tipo</mat-label>
                                    <mat-select formControlName="tipo">
                                        <mat-option value="ENTRADA">Entrada (+)</mat-option>
                                        <mat-option value="SALIDA">Salida (-)</mat-option>
                                    </mat-select>
                                </mat-form-field>

                                <mat-form-field appearance="outline">
                                    <mat-label>Monto</mat-label>
                                    <input matInput type="number" formControlName="monto" placeholder="0.00">
                                    <span matTextPrefix>$&nbsp;</span>
                                </mat-form-field>
                            </div>

                            <mat-form-field appearance="outline" class="full-width">
                                <mat-label>Motivo</mat-label>
                                <input matInput formControlName="motivo" placeholder="Ej. Compra de hielo">
                            </mat-form-field>

                            <button mat-raised-button color="accent" type="submit" [disabled]="movimientoForm.invalid">
                                Registrar Movimiento
                            </button>
                        </form>

                        <div class="log-container">
                            <h3>Historial de Movimientos</h3>
                            <table mat-table [dataSource]="movimientos" class="mat-elevation-z1 full-width">
                                <ng-container matColumnDef="fecha">
                                    <th mat-header-cell *matHeaderCellDef> Hora </th>
                                    <td mat-cell *matCellDef="let element" data-label="Hora"> {{element.fecha |
                                        date:'shortTime'}} </td>
                                </ng-container>

                                <ng-container matColumnDef="tipo">
                                    <th mat-header-cell *matHeaderCellDef> Tipo </th>
                                    <td mat-cell *matCellDef="let element"
                                        [class.text-success]="element.tipo === 'ENTRADA'"
                                        [class.text-danger]="element.tipo === 'SALIDA'" data-label="Tipo">
                                        {{element.tipo}}
                                    </td>
                                </ng-container>

                                <ng-container matColumnDef="motivo">
                                    <th mat-header-cell *matHeaderCellDef> Motivo </th>
                                    <td mat-cell *matCellDef="let element" data-label="Motivo"> {{element.motivo}} </td>
                                </ng-container>

                                <ng-container matColumnDef="monto">
                                    <th mat-header-cell *matHeaderCellDef> Monto </th>
                                    <td mat-cell *matCellDef="let element" data-label="Monto"> {{element.monto |
                                        currency}} </td>
                                </ng-container>

                                <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                                <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
                            </table>
                        </div>
                    </div>
                </mat-tab>

                <!-- Tab 3: Cierre -->
                <mat-tab label="Cierre de Caja" [disabled]="!cajaActual && !reporteCierre">
                    <div class="tab-content">

                        <!-- Fase A: Conteo -->
                        <div *ngIf="cierreFase === 'CONTEO' && cajaActual">
                            <div class="alert-info">
                                <mat-icon>visibility_off</mat-icon>
                                <span>Modo Conteo Ciego: Ingrese el efectivo total en caja.</span>
                            </div>

                            <form [formGroup]="cierreForm" (ngSubmit)="iniciarCierre()">
                                <mat-form-field appearance="outline" class="full-width">
                                    <mat-label>Efectivo Contado (Total)</mat-label>
                                    <input matInput type="number" formControlName="montoContado" placeholder="0.00">
                                    <span matTextPrefix>$&nbsp;</span>
                                </mat-form-field>

                                <mat-form-field appearance="outline" class="full-width">
                                    <mat-label>Fondo para Próximo Turno</mat-label>
                                    <input matInput type="number" formControlName="fondoProximo" placeholder="0.00">
                                    <span matTextPrefix>$&nbsp;</span>
                                    <mat-hint>Este monto se dejará en caja.</mat-hint>
                                </mat-form-field>

                                <button mat-raised-button color="warn" type="submit" [disabled]="cierreForm.invalid">
                                    Finalizar y Realizar Arqueo
                                </button>
                            </form>
                        </div>

                        <!-- Fase B: Reporte -->
                        <div *ngIf="cierreFase === 'REPORTE' && reporteCierre" class="reporte-container">
                            <h3>Resultado del Arqueo</h3>

                            <div class="reporte-grid">
                                <div class="reporte-item">
                                    <span class="label">Total Esperado</span>
                                    <span class="value">{{ reporteCierre.esperado | currency }}</span>
                                </div>
                                <div class="reporte-item">
                                    <span class="label">Total Contado</span>
                                    <span class="value">{{ reporteCierre.contado | currency }}</span>
                                </div>
                                <div class="reporte-item highlight" [ngClass]="{
                  'success': reporteCierre.estadoDescuadre === 'OK',
                  'warning': reporteCierre.estadoDescuadre === 'SOBRANTE',
                  'danger': reporteCierre.estadoDescuadre === 'FALTANTE'
                }">
                                    <span class="label">Descuadre ({{ reporteCierre.estadoDescuadre }})</span>
                                    <span class="value">{{ reporteCierre.descuadre | currency }}</span>
                                </div>
                            </div>

                            <div class="action-area">
                                <p>Retirar para depósito: <strong>{{ (reporteCierre.contado -
                                        reporteCierre.fondoProximo) | currency }}</strong></p>
                                <button mat-raised-button color="primary" (click)="nuevoTurno()">
                                    Iniciar Nuevo Turno
                                </button>
                            </div>
                        </div>

                    </div>
                </mat-tab>

            </mat-tab-group>
        </mat-card-content>
    </mat-card>
</div>